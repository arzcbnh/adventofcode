#!/usr/bin/env sh

CC="gcc -g -std=c99 -pedantic -W -Wall -Werror -lm"
PROGRAM=""
INPUT="input"
VALGRIND="false"

for arg in "$@"; do
	case "$arg" in
		*.c)
			PROGRAM="$arg"
			;;
		-t)
			INPUT="test"
			;;
		-v)
			VALGRIND="true"
			;;
	esac
done

if [ -z "$PROGRAM" ]; then
	echo "Error: no program selected"
	exit 1
fi

if ! ls strmanip.o > /dev/null 2>&1; then
	eval "$CC -c strmanip.c"
fi

if ! ls memmanage.o > /dev/null 2>&1; then
	eval "$CC -c memmanage.c"
fi

eval "$CC $PROGRAM strmanip.c memmanage.c" && ./a.out < "$INPUT" && {
	if [ "$VALGRIND" = "true" ]; then
		head -n 1 > /dev/null
		valgrind -s --leak-check=full --track-origins=yes --max-stackframe=10000000 ./a.out < "$INPUT"
	fi
}
